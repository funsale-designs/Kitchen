<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Stock Manager</title>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://dkblxerbnokaeavwnlsu.supabase.co'
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY'  // replace with your anon/public key
const supabase = createClient(supabaseUrl, supabaseKey)

// UTIL
const $ = id => document.getElementById(id)

// --- KITCHENS ---
const kitchens = ['Store Room','Kitchen 1 Frail','Kitchen 2 Catering','Kitchen 3 Kefi','Kitchen 4 Frail FOH']

// --- NAV ---
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'))
  $(id).classList.remove('hidden')
}

// --- STOCK MANAGEMENT ---
async function addStockItem(){
  const name = $('stockName').value.trim()
  const qty = parseInt($('stockQty').value)
  const kitchen = $('stockKitchen').value
  if(!name || qty <=0){ $('stockMsg').textContent='Enter valid name & qty'; return }

  const { error } = await supabase.from('stock').insert([{name, qty, kitchen}])
  if(error){ console.error(error); $('stockMsg').textContent='Error adding'; return }
  $('stockMsg').textContent='Added!'
  $('stockName').value=''; $('stockQty').value=''
  fetchStock()
}

async function fetchStock(){
  const { data, error } = await supabase.from('stock').select('*').order('name')
  if(error){ console.error(error); return }
  const list = $('stockList')
  list.innerHTML = ''
  let lowStockItems = []
  data.forEach(s=>{
    const li = document.createElement('li')
    li.textContent = `${s.name} (${s.kitchen}): ${s.qty}`
    list.appendChild(li)
    if(s.kitchen==='Store Room' && s.qty<3) lowStockItems.push(s.name)
  })
  $('lowStock').textContent = lowStockItems.length ? 'Low stock: ' + lowStockItems.join(', ') : 'All good'
}

// --- RECIPES ---
$('addIngredient').addEventListener('click', ()=>{
  const div = document.createElement('div')
  div.classList.add('flex','mb-1')
  div.innerHTML = `
    <input type="text" placeholder="Ingredient" class="p-2 border rounded flex-1 mr-1 ing-name">
    <input type="number" placeholder="Qty" class="p-2 border rounded flex-1 ing-qty">
  `
  $('ingredientsContainer').appendChild(div)
})

$('addRecipe').addEventListener('click', async ()=>{
  const name = $('recipeName').value.trim()
  if(!name){ $('recipeMsg').textContent='Enter recipe name'; return }

  const ingElems = document.querySelectorAll('#ingredientsContainer > div')
  let ingredients = {}
  ingElems.forEach(div=>{
    const ing = div.querySelector('.ing-name').value.trim()
    const qty = parseFloat(div.querySelector('.ing-qty').value)
    if(ing && qty>0) ingredients[ing] = qty
  })
  if(Object.keys(ingredients).length === 0){ $('recipeMsg').textContent='Add at least 1 ingredient'; return }

  const { error } = await supabase.from('recipes').insert([{name, ingredients}])
  if(error){ console.error(error); $('recipeMsg').textContent='Error adding recipe'; return }

  $('recipeMsg').textContent='Recipe added!'
  $('recipeName').value=''
  $('ingredientsContainer').innerHTML = `<div class="flex mb-1">
      <input type="text" placeholder="Ingredient" class="p-2 border rounded flex-1 mr-1 ing-name">
      <input type="number" placeholder="Qty" class="p-2 border rounded flex-1 ing-qty">
  </div>`
  fetchRecipes()
})

async function fetchRecipes(){
  const { data, error } = await supabase.from('recipes').select('*')
  if(error){ console.error(error); return }
  const list = $('recipeList')
  list.innerHTML = ''
  data.forEach(r=>{
    const li = document.createElement('li')
    li.textContent = `${r.name} â€” Ingredients: ${JSON.stringify(r.ingredients)}`
    list.appendChild(li)
  })
}

// --- ON LOAD ---
document.addEventListener('DOMContentLoaded', ()=>{
  kitchens.forEach(k=>{
    const opt = document.createElement('option')
    opt.value = k
    opt.textContent = k
    $('stockKitchen').appendChild(opt)
  })
  fetchStock()
  fetchRecipes()
})
</script>
<style>
body{font-family:sans-serif;background:#f8f9fa;margin:0;padding:0}
.page{padding:10px}
.hidden{display:none}
button{margin-top:5px;width:100%;padding:10px;border:none;color:white;border-radius:5px;font-size:16px}
.bg-blue{background:#007BFF}
.bg-green{background:#28A745}
.bg-orange{background:#FD7E14}
input{width:100%;margin-bottom:5px}
ul{padding-left:20px; max-height:150px; overflow:auto}
</style>
</head>
<body>

<nav class="bg-blue p-2 text-white flex justify-around">
  <button onclick="showPage('stockPage')">Stock</button>
  <button onclick="showPage('recipePage')">Recipes</button>
</nav>

<!-- STOCK PAGE -->
<div id="stockPage" class="page">
  <h2>Stock Management</h2>
  <input id="stockName" placeholder="Item Name">
  <input type="number" id="stockQty" placeholder="Qty">
  <select id="stockKitchen"></select>
  <button class="bg-green" onclick="addStockItem()">Add Item</button>
  <p id="stockMsg" style="color:red;"></p>
  <ul id="stockList"></ul>
  <p id="lowStock" style="color:orange;font-weight:bold;"></p>
</div>

<!-- RECIPE PAGE -->
<div id="recipePage" class="page hidden">
  <h2>Recipes</h2>
  <input id="recipeName" placeholder="Recipe Name">
  <div id="ingredientsContainer">
    <div class="flex mb-1">
      <input type="text" placeholder="Ingredient" class="p-2 border rounded flex-1 mr-1 ing-name">
      <input type="number" placeholder="Qty" class="p-2 border rounded flex-1 ing-qty">
    </div>
  </div>
  <button id="addIngredient" class="bg-orange">Add Ingredient</button>
  <button id="addRecipe" class="bg-green">Add Recipe</button>
  <p id="recipeMsg" style="color:red;"></p>
  <ul id="recipeList"></ul>
</div>

</body>
</html>
